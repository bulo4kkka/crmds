{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0" style="font-family: 'Montserrat', sans-serif;">
        <i class="bi bi-clipboard-plus me-2"></i>Новый заказ-наряд
    </h2>
    <a href="/work_orders" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Назад к списку
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Основная информация</h5>
            </div>
            <div class="card-body">
                <form id="workOrderForm">
                    <div class="mb-3">
                        <label class="form-label">Клиент *</label>
                        <select class="form-select" id="clientSelect" required>
                            <option value="">-- Выберите клиента --</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">
                                {{ client.full_name }} - {{ client.car_model }} ({{ client.phone }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Описание работ *</label>
                        <textarea class="form-control" id="description" rows="3" required 
                                  placeholder="Опишите проблему и необходимые работы..."></textarea>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Работы -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Работы</h5>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addWork()">
                    <i class="bi bi-plus"></i> Добавить работу
                </button>
            </div>
            <div class="card-body">
                <div id="worksContainer">
                    <!-- Первая строка будет добавлена через JavaScript -->
                </div>
                <div class="mt-2 text-end">
                    <small>Итого по работам: <span id="worksTotal">0</span> ₽</small>
                </div>
            </div>
        </div>

        <!-- Расходы -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Расходы</h5>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addExpense()">
                    <i class="bi bi-plus"></i> Добавить расход
                </button>
            </div>
            <div class="card-body">
                <div id="expensesContainer">
                    <!-- Первая строка будет добавлена через JavaScript -->
                </div>
                <div class="mt-2 text-end">
                    <small>Итого по расходам: <span id="expensesTotal">0</span> ₽</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Итоговая информация -->
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h5 class="mb-0">Итог</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Номер заказа</label>
                    <input type="text" class="form-control" id="orderNumber" readonly>
                </div>

                <div class="mb-3">
                    <h6>Финансовый расчет:</h6>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Доход от работ:</span>
                        <span id="incomeAmount">0 ₽</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Расходы:</span>
                        <span id="expensesAmount">0 ₽</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-1">
                        <strong>Итоговая сумма:</strong>
                        <strong id="totalAmount">0 ₽</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small>Чистая прибыль:</small>
                        <small id="netProfit">0 ₽</small>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" onclick="saveWorkOrder()">
                        <i class="bi bi-save"></i> Сохранить заказ-наряд
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
let workCounter = 0;
let expenseCounter = 0;

// Генерация номера заказа
function generateOrderNumber() {
    const now = new Date();
    const dateStr = now.getFullYear().toString().slice(-2) +
                   (now.getMonth() + 1).toString().padStart(2, '0') +
                   now.getDate().toString().padStart(2, '0');

    // Получаем следующий номер
    $.get('/api/work_orders/last_number?date=' + dateStr, function(response) {
        if (response.success) {
            $('#orderNumber').val(response.next_number);
        } else {
            $('#orderNumber').val(dateStr + '-001');
        }
    }).fail(function() {
        $('#orderNumber').val(dateStr + '-001');
    });
}

// Добавление работы
function addWork() {
    workCounter++;
    const html = `
        <div class="work-item row mb-2" id="work-${workCounter}">
            <div class="col-md-5">
                <input type="text" class="form-control form-control-sm work-name" placeholder="Название работы"
                       oninput="calculateTotals()" required>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control form-control-sm work-quantity" placeholder="Кол-во"
                       value="1" min="1" step="1" oninput="calculateTotals()">
            </div>
            <div class="col-md-3">
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control work-price" placeholder="Цена за ед."
                           step="0.01" min="0" oninput="calculateTotals()" required>
                    <span class="input-group-text">₽</span>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeWork(this)">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    `;
    $('#worksContainer').append(html);
    calculateTotals();
}

// Удаление работы
function removeWork(button) {
    $(button).closest('.work-item').remove();
    calculateTotals();
}

// Добавление расхода
function addExpense() {
    expenseCounter++;
    const html = `
        <div class="expense-item row mb-2" id="expense-${expenseCounter}">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm expense-name" placeholder="Название расхода"
                       oninput="calculateTotals()" required>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm expense-type" onchange="calculateTotals()">
                    <option value="material">Материалы</option>
                    <option value="parts">Запчасти</option>
                    <option value="other">Прочее</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control form-control-sm expense-quantity" placeholder="Кол-во"
                       value="1" min="1" step="1" oninput="calculateTotals()">
            </div>
            <div class="col-md-2">
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control expense-cost" placeholder="Стоимость"
                           step="0.01" min="0" oninput="calculateTotals()" required>
                    <span class="input-group-text">₽</span>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeExpense(this)">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    `;
    $('#expensesContainer').append(html);
    calculateTotals();
}

// Удаление расхода
function removeExpense(button) {
    $(button).closest('.expense-item').remove();
    calculateTotals();
}

// Расчет итогов
function calculateTotals() {
    let worksTotal = 0;
    $('.work-item').each(function() {
        const quantity = parseFloat($(this).find('.work-quantity').val()) || 0;
        const price = parseFloat($(this).find('.work-price').val()) || 0;
        if (quantity > 0 && price > 0) {
            worksTotal += quantity * price;
        }
    });

    let expensesTotal = 0;
    $('.expense-item').each(function() {
        const quantity = parseFloat($(this).find('.expense-quantity').val()) || 0;
        const cost = parseFloat($(this).find('.expense-cost').val()) || 0;
        if (quantity > 0 && cost > 0) {
            expensesTotal += quantity * cost;
        }
    });

    // Округляем до 2 знаков после запятой
    worksTotal = Math.round(worksTotal * 100) / 100;
    expensesTotal = Math.round(expensesTotal * 100) / 100;
    const totalAmount = worksTotal;
    const netProfit = worksTotal - expensesTotal;

    $('#worksTotal').text(worksTotal.toFixed(2));
    $('#expensesTotal').text(expensesTotal.toFixed(2));
    $('#incomeAmount').text(worksTotal.toFixed(2) + ' ₽');
    $('#expensesAmount').text(expensesTotal.toFixed(2) + ' ₽');
    $('#totalAmount').text(totalAmount.toFixed(2) + ' ₽');
    $('#netProfit').text(netProfit.toFixed(2) + ' ₽');
}

// Сохранение заказ-наряда
function saveWorkOrder() {
    const clientId = $('#clientSelect').val();
    const description = $('#description').val();
    const orderNumber = $('#orderNumber').val();

    if (!clientId) {
        alert('Пожалуйста, выберите клиента');
        return;
    }

    if (!description.trim()) {
        alert('Пожалуйста, введите описание работ');
        return;
    }

    // Проверка работ
    let hasWorks = false;
    $('.work-item').each(function() {
        const name = $(this).find('.work-name').val();
        const price = $(this).find('.work-price').val();
        if (name && price) {
            hasWorks = true;
        }
    });

    if (!hasWorks) {
        alert('Пожалуйста, добавьте хотя бы одну работу');
        return;
    }

    // Сбор работ
    const works = [];
    $('.work-item').each(function() {
        const name = $(this).find('.work-name').val().trim();
        const quantity = parseFloat($(this).find('.work-quantity').val()) || 1;
        const price = parseFloat($(this).find('.work-price').val()) || 0;

        if (name && price > 0) {
            works.push({
                name: name,
                quantity: quantity,
                price: price
            });
        }
    });

    // Сбор расходов
    const expenses = [];
    $('.expense-item').each(function() {
        const name = $(this).find('.expense-name').val().trim();
        const type = $(this).find('.expense-type').val();
        const quantity = parseFloat($(this).find('.expense-quantity').val()) || 1;
        const cost = parseFloat($(this).find('.expense-cost').val()) || 0;

        if (name && cost > 0) {
            expenses.push({
                name: name,
                type: type,
                quantity: quantity,
                cost: cost
            });
        }
    });

    const orderData = {
        client_id: parseInt(clientId),
        description: description.trim(),
        order_number: orderNumber,
        works: works,
        expenses: expenses
    };

    console.log('Отправляемые данные:', orderData);

    // Показываем индикатор загрузки
    const saveBtn = $('.btn-primary');
    const originalText = saveBtn.html();
    saveBtn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Сохранение...');
    saveBtn.prop('disabled', true);

    $.ajax({
        url: '/api/work_orders/add',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(orderData),
        success: function(response) {
            if (response.success) {
                alert('✅ Заказ-наряд успешно создан! Номер: ' + response.order_number);
                window.location.href = '/work_orders';
            } else {
                alert('❌ Ошибка: ' + response.error);
                saveBtn.html(originalText);
                saveBtn.prop('disabled', false);
            }
        },
        error: function(xhr) {
            try {
                const error = JSON.parse(xhr.responseText);
                alert('❌ Ошибка: ' + error.error);
            } catch {
                alert('❌ Ошибка сервера: ' + xhr.statusText);
            }
            saveBtn.html(originalText);
            saveBtn.prop('disabled', false);
        }
    });
}

// Инициализация
$(document).ready(function() {
    generateOrderNumber();

    // Добавляем начальные строки
    addWork();
    addExpense();

    // Автоматический пересчет при изменении
    $(document).on('input change', '.work-quantity, .work-price, .expense-quantity, .expense-cost', function() {
        calculateTotals();
    });

    // Валидация формы
    $('#workOrderForm').on('submit', function(e) {
        e.preventDefault();
        saveWorkOrder();
    });
});
</script>
{% endblock %}
{% endblock %}